<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 12 Ultra Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- Core System --- */
        :root {
            --bg-glass: rgba(255, 255, 255, 0.85);
            --bg-window: rgba(255, 255, 255, 0.95);
            --text-color: #000;
            --border-color: rgba(0,0,0,0.1);
            --hover-bg: rgba(0,0,0,0.05);
        }
        
        .dark-mode {
            --bg-glass: rgba(30, 30, 30, 0.85);
            --bg-window: rgba(32, 32, 32, 0.95);
            --text-color: #fff;
            --border-color: rgba(255,255,255,0.1);
            --hover-bg: rgba(255,255,255,0.1);
        }

        body {
            overflow: hidden;
            font-family: 'Segoe UI Variable', 'Segoe UI', Tahoma, sans-serif;
            user-select: none;
            margin: 0; padding: 0;
            background: #000;
            cursor: default;
            color: var(--text-color);
        }

        /* --- Visuals --- */
        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            transition: background 0.3s, color 0.3s;
        }

        /* Brightness Overlay */
        #brightness-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none; z-index: 9998;
            transition: opacity 0.1s;
        }

        /* Animations */
        @keyframes winPop { 0% { transform: scale(0.95) translateY(10px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%) translateX(-50%); } to { transform: translateY(0) translateX(-50%); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-ring { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }

        /* Wallpaper */
        .desktop-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: background-image 0.5s ease-in-out;
            z-index: 0;
        }

        /* --- Window System --- */
        .window {
            position: absolute;
            border-radius: 8px;
            display: flex; flex-direction: column;
            overflow: hidden;
            min-width: 300px; min-height: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            animation: winPop 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            resize: both;
            background: var(--bg-window);
            color: var(--text-color);
            pointer-events: auto;
        }
        .window-header {
            height: 40px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: default; 
            background: transparent;
            border-bottom: 1px solid var(--border-color);
        }
        .win-controls { display: flex; height: 100%; }
        .win-btn {
            width: 46px; height: 100%; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; cursor: pointer; font-size: 14px;
        }
        .win-btn:hover { background: var(--hover-bg); }
        .win-btn.close:hover { background: #e81123; color: white; }
        
        .window-content { flex-grow: 1; position: relative; overflow: auto; }

        /* Desktop Icons */
        .desktop-icon {
            position: absolute;
            width: 86px; height: 96px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 4px; transition: background 0.2s;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            cursor: pointer;
            z-index: 10; 
        }
        .desktop-icon:hover { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
        .desktop-icon.selected { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); }

        /* Taskbar */
        .taskbar-container {
            position: absolute; bottom: 12px; left: 0; width: 100%;
            display: flex; justify-content: center;
            z-index: 9000;
        }
        .taskbar {
            height: 52px;
            display: flex; align-items: center; gap: 6px;
            padding: 0 12px;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .task-icon {
            width: 40px; height: 40px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            position: relative;
        }
        .task-icon:hover { background: rgba(255,255,255,0.15); }
        .task-icon.active::after {
            content: ''; position: absolute; bottom: -4px; width: 12px; height: 3px;
            background: #60cdff; border-radius: 2px;
        }
        .task-icon i { font-size: 22px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }

        /* Start Menu */
        .start-menu {
            position: absolute; bottom: 76px; left: 50%; transform: translateX(-50%);
            width: 640px; height: 600px;
            border-radius: 8px;
            display: none; flex-direction: column;
            z-index: 9001;
            padding: 24px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            color: var(--text-color);
        }
        .start-menu.active { display: flex; }

        /* Emulators */
        .android-frame { background: #111; border-radius: 30px; padding: 10px; border: 2px solid #333; height: 100%; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .android-screen { flex-grow: 1; background: black; border-radius: 20px; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .android-app { display: none; width: 100%; height: 100%; background: white; flex-direction: column; animation: fadeIn 0.2s; flex-grow: 1; overflow: hidden;}
        .android-app.active { display: flex; }
        
        /* Mac Emulator */
        .mac-frame { display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; background: #333; }
        .mac-desktop { flex-grow: 1; position: relative; background: url('https://images.unsplash.com/photo-1496664444929-8c75efb9546f?w=800') center/cover; }
        .mac-window-vm { position: absolute; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; }
        .mac-dock { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 8px; border-radius: 16px; display: flex; gap: 8px; border: 1px solid rgba(255,255,255,0.2); }
        .mac-dock-icon { width: 40px; height: 40px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .mac-dock-icon:hover { transform: scale(1.1) translateY(-5px); }

        /* Explorer Grid */
        .file-item { display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 4px; cursor: pointer; text-align: center; width: 90px; }
        .file-item:hover { background: rgba(0,0,0,0.05); }
        .file-item.selected { background: #cce8ff; border: 1px solid #99d1ff; }
        .tree-node { padding: 4px 8px; cursor: pointer; display: flex; gap: 6px; align-items: center; border-radius: 4px; }
        .tree-node:hover { background: rgba(0,0,0,0.05); }

        /* Office Ribbon */
        .ribbon { display: flex; gap: 10px; padding: 8px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; align-items: center; }
        .dark-mode .ribbon { background: #2d2d2d; border-color: #404040; }
        .ribbon-btn { padding: 4px 8px; border-radius: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; gap: 2px; }
        .ribbon-btn:hover { background: rgba(0,0,0,0.1); }
        .dark-mode .ribbon-btn:hover { background: rgba(255,255,255,0.1); }
        .ribbon-sep { width: 1px; height: 24px; background: #ccc; margin: 0 4px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="brightness-overlay"></div>

    <!-- Boot Screen -->
    <div id="boot-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; background:black; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <i class="fab fa-windows text-6xl text-blue-500 mb-6"></i>
        <div id="boot-loader" class="loader w-8 h-8 border-2 border-t-transparent border-white rounded-full animate-spin"></div>
        <div id="boot-text" class="mt-4 text-sm font-light">טוען מערכת...</div>
    </div>

    <!-- Desktop -->
    <div id="desktop-env" style="display: none; height: 100vh; position: relative; overflow: hidden;">
        <div id="wallpaper" class="desktop-bg" style="background-image: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');"></div>

        <div id="desktop-icons-layer" class="absolute top-0 left-0 w-full h-full z-10"></div>
        <!-- IMPORTANT: pointer-events-none ensures clicks pass through to icons when no window is hit -->
        <div id="windows-container" class="absolute top-0 left-0 w-full h-full z-20 pointer-events-none"></div>

        <!-- Start Menu -->
        <div id="start-menu" class="start-menu glass">
            <div class="bg-black/5 rounded-full px-4 py-2 flex items-center gap-2 mb-6 border border-white/10">
                <i class="fas fa-search opacity-50"></i>
                <input type="text" placeholder="חיפוש באפליקציות, הגדרות ומסמכים" class="bg-transparent border-none outline-none w-full text-sm placeholder-gray-500">
            </div>
            <div class="flex-grow overflow-auto">
                <div class="font-bold text-sm mb-4 px-2 opacity-80">ננעצו</div>
                <div class="grid grid-cols-6 gap-2" id="start-pinned"></div>
                <div class="font-bold text-sm mt-8 mb-4 px-2 opacity-80">מומלצים</div>
                <div class="grid grid-cols-2 gap-2" id="start-recommended"></div>
            </div>
            <div class="border-t border-gray-400/20 pt-4 flex justify-between items-center px-4 mt-2">
                <div class="flex items-center gap-3 cursor-pointer hover:bg-black/5 p-2 rounded-md transition">
                    <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold">A</div>
                    <span class="text-sm font-semibold">Admin</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="systemAction('restart')" class="w-8 h-8 rounded hover:bg-black/10 flex items-center justify-center text-orange-600" title="הפעלה מחדש"><i class="fas fa-sync-alt"></i></button>
                    <button onclick="systemAction('shutdown')" class="w-8 h-8 rounded hover:bg-black/10 flex items-center justify-center text-red-600" title="כיבוי"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </div>

        <!-- Taskbar -->
        <div class="taskbar-container">
            <div class="taskbar glass">
                <div class="task-icon" onclick="toggleStartMenu()"><i class="fab fa-windows text-blue-500"></i></div>
                <div id="taskbar-apps" class="flex gap-1 mx-2"></div>
                <div class="task-icon ml-auto text-xs flex flex-col items-end px-2" onclick="openWindow('settings')">
                    <span id="clock-time" class="font-bold">12:00</span>
                    <span id="clock-date">01/01</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Virtual File System (VFS) Core ---
        class VirtualFileSystem {
            constructor() {
                this.root = {
                    type: 'folder',
                    name: 'C:',
                    children: {
                        'Users': {
                            type: 'folder', children: {
                                'Admin': {
                                    type: 'folder', children: {
                                        'Desktop': { type: 'folder', children: {} },
                                        'Documents': { 
                                            type: 'folder', children: {
                                                'Project.docx': { type: 'file', app: 'word', content: '<h1>Project Alpha</h1>' },
                                                'Budget.xlsx': { type: 'file', app: 'excel', content: '' }
                                            }
                                        },
                                        'Pictures': { type: 'folder', children: {
                                            'Vacation.jpg': { type: 'file', app: 'gallery', content: '' }
                                        } },
                                        'Downloads': { type: 'folder', children: {
                                            'Setup.exe': { type: 'file', app: 'cmd', content: '' }
                                        } }
                                    }
                                }
                            }
                        }
                    }
                };
                this.clipboard = null; 
            }

            resolve(pathArr) {
                let curr = this.root;
                for (let p of pathArr) {
                    if (curr.children && curr.children[p]) curr = curr.children[p];
                    else return null;
                }
                return curr;
            }

            write(pathArr, name, content, app) {
                const dir = this.resolve(pathArr);
                if (dir && dir.type === 'folder') {
                    dir.children[name] = { type: 'file', content, app };
                    return true;
                }
                return false;
            }

            copy(pathArr, name) {
                const dir = this.resolve(pathArr);
                if (dir && dir.children[name]) {
                    this.clipboard = { action: 'copy', node: JSON.parse(JSON.stringify(dir.children[name])), name: name };
                    return true;
                }
                return false;
            }

            cut(pathArr, name) {
                const dir = this.resolve(pathArr);
                if (dir && dir.children[name]) {
                    this.clipboard = { action: 'move', node: dir.children[name], name: name, parent: dir };
                    return true;
                }
                return false;
            }

            paste(pathArr) {
                if (!this.clipboard) return false;
                const dir = this.resolve(pathArr);
                if (dir && dir.type === 'folder') {
                    let newName = this.clipboard.name;
                    let counter = 1;
                    while(dir.children[newName]) { 
                        const parts = this.clipboard.name.split('.');
                        if(parts.length > 1) {
                            const ext = parts.pop();
                            newName = parts.join('.') + ` (${counter}).` + ext;
                        } else {
                            newName = this.clipboard.name + ` (${counter})`;
                        }
                        counter++; 
                    }
                    
                    dir.children[newName] = this.clipboard.action === 'copy' ? JSON.parse(JSON.stringify(this.clipboard.node)) : this.clipboard.node;
                    
                    if (this.clipboard.action === 'move' && this.clipboard.parent) {
                        delete this.clipboard.parent.children[this.clipboard.name];
                        this.clipboard = null; 
                    }
                    return true;
                }
                return false;
            }
        }

        const vfs = new VirtualFileSystem();
        let zIndex = 100;
        let activeWindows = {};
        const systemState = {
            darkMode: false,
            brightness: 100,
            wallpaper: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80'
        };

        // --- Apps Config ---
        const apps = [
            { id: 'explorer', name: 'סייר הקבצים', icon: 'fa-folder-open', color: 'text-yellow-500', w: 850, h: 550, init: initExplorer },
            { id: 'word', name: 'Word', icon: 'fa-file-word', color: 'text-blue-600', w: 900, h: 650, init: initWord },
            { id: 'excel', name: 'Excel', icon: 'fa-file-excel', color: 'text-green-600', w: 900, h: 650, init: initExcel },
            { id: 'ppt', name: 'PowerPoint', icon: 'fa-file-powerpoint', color: 'text-orange-600', w: 900, h: 650, init: initPPT },
            { id: 'settings', name: 'הגדרות', icon: 'fa-cog', color: 'text-gray-500', w: 800, h: 550, init: initSettings },
            { id: 'cmd', name: 'Terminal', icon: 'fa-terminal', color: 'text-gray-700', w: 600, h: 400, init: initCMD },
            { id: 'notes', name: 'פנקס רשימות', icon: 'fa-sticky-note', color: 'text-gray-600', w: 400, h: 300, init: initNotepad },
            { id: 'android', name: 'Android', icon: 'fa-robot', color: 'text-green-500', w: 380, h: 720, init: initAndroid },
            { id: 'mac', name: 'macOS VM', icon: 'fa-laptop', color: 'text-gray-800', w: 850, h: 550, init: initMac }
        ];

        // --- Boot ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('boot-screen').style.display = 'none';
                document.getElementById('desktop-env').style.display = 'block';
                initDesktop();
            }, 1500);
        };

        function initDesktop() {
            renderDesktopIcons();
            renderTaskbar();
            renderStartMenu();
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('clock-date').innerText = now.toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'});
            }, 1000);
        }

        // --- UI Rendering & Logic ---
        function renderDesktopIcons() {
            const container = document.getElementById('desktop-icons-layer');
            const icons = [
                { app: 'explorer', label: 'מחשב זה', icon: 'fa-desktop', color: 'text-blue-400' },
                { app: 'word', label: 'Word', icon: 'fa-file-word', color: 'text-blue-600' },
                { app: 'excel', label: 'Excel', icon: 'fa-file-excel', color: 'text-green-600' },
                { app: 'ppt', label: 'PowerPoint', icon: 'fa-file-powerpoint', color: 'text-orange-600' },
                { app: 'settings', label: 'הגדרות', icon: 'fa-cog', color: 'text-gray-300' },
                { app: 'android', label: 'Android', icon: 'fa-robot', color: 'text-green-500' },
                { app: 'mac', label: 'macOS VM', icon: 'fa-laptop', color: 'text-gray-200' }
            ];
            
            let row=0, col=0;
            icons.forEach(i => {
                const div = document.createElement('div');
                div.className = 'desktop-icon';
                div.style.top = (20 + row * 106) + 'px';
                div.style.right = (20 + col * 96) + 'px'; // RTL
                div.innerHTML = `<i class="fas ${i.icon} text-3xl mb-2 ${i.color}"></i><span class="text-xs text-center leading-tight shadow-black">${i.label}</span>`;
                
                // FIXED DRAG LOGIC (Global Mouseup)
                div.onmousedown = (e) => {
                    if(e.button !== 0) return;
                    div.classList.add('selected');
                    const rect = div.getBoundingClientRect();
                    let shiftX = e.clientX - rect.left;
                    let shiftY = e.clientY - rect.top;
                    
                    function moveAt(pageX, pageY) {
                        let newTop = pageY - shiftY;
                        let newLeft = pageX - shiftX;
                        div.style.top = newTop + 'px';
                        div.style.left = newLeft + 'px'; 
                        div.style.right = 'auto'; 
                    }
                    function onMouseMove(event) { moveAt(event.pageX, event.pageY); }
                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        div.classList.remove('selected');
                    }
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp); // Attach to doc
                };

                div.ondblclick = () => openWindow(i.app);
                container.appendChild(div);
                row++; if(row > 5) { row=0; col++; }
            });
        }

        function renderTaskbar() {
            const container = document.getElementById('taskbar-apps');
            apps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'task-icon';
                div.id = 'task-' + app.id;
                div.onclick = () => openWindow(app.id);
                div.innerHTML = `<i class="fas ${app.icon} ${app.color}"></i>`;
                container.appendChild(div);
            });
        }

        function renderStartMenu() {
            const pinned = document.getElementById('start-pinned');
            apps.forEach(app => {
                const el = document.createElement('div');
                el.className = 'flex flex-col items-center gap-2 cursor-pointer p-2 hover:bg-white/10 rounded-lg transition';
                el.onclick = () => { openWindow(app.id); toggleStartMenu(); };
                el.innerHTML = `<i class="fas ${app.icon} text-xl ${app.color}"></i><span class="text-xs opacity-90">${app.name}</span>`;
                pinned.appendChild(el);
            });
        }

        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            if(menu.classList.contains('active')) menu.classList.remove('active');
            else { menu.classList.add('active'); menu.style.zIndex = ++zIndex + 100; }
        }

        // --- Window Manager ---
        function openWindow(appId, content=null, filename=null, path=null) {
            const app = apps.find(a => a.id === appId);
            const id = appId + '_' + Date.now();
            zIndex++;
            document.getElementById('windows-container').style.pointerEvents = 'auto';

            const win = document.createElement('div');
            win.className = 'window glass';
            win.id = id;
            win.style.width = app.w + 'px'; win.style.height = app.h + 'px';
            win.style.zIndex = zIndex;
            win.style.top = (50 + Math.random()*50) + 'px'; win.style.left = (50 + Math.random()*50) + 'px';

            const header = document.createElement('div');
            header.className = 'window-header';
            header.innerHTML = `
                <div class="flex items-center gap-3 px-3 text-sm font-semibold opacity-80">
                    <i class="fas ${app.icon}"></i>
                    <span>${filename ? filename + ' - ' : ''}${app.name}</span>
                </div>
                <div class="win-controls">
                    <div class="win-btn" onclick="minimizeWindow('${id}')"><i class="fas fa-minus"></i></div>
                    <div class="win-btn" onclick="maximizeWindow('${id}')"><i class="far fa-square"></i></div>
                    <div class="win-btn close" onclick="closeWindow('${id}')"><i class="fas fa-times"></i></div>
                </div>
            `;
            
            // FIXED DRAG LOGIC (Global Mouseup)
            header.onmousedown = (e) => {
                if(e.target.closest('.win-btn')) return;
                zIndex++; win.style.zIndex = zIndex;
                let shiftX = e.clientX - win.getBoundingClientRect().left;
                let shiftY = e.clientY - win.getBoundingClientRect().top;
                
                function moveAt(pageX, pageY) {
                    win.style.left = (pageX - shiftX) + 'px';
                    win.style.top = (pageY - shiftY) + 'px';
                }
                function onMouseMove(event) { moveAt(event.pageX, event.pageY); }
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp); // Attach to doc
            };

            const contentDiv = document.createElement('div');
            contentDiv.className = 'window-content';
            
            win.appendChild(header);
            win.appendChild(contentDiv);
            document.getElementById('windows-container').appendChild(win);
            document.getElementById('task-'+appId).classList.add('active');
            
            if(app.init) app.init(contentDiv, id, content, filename, path);
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            win.style.opacity = 0; win.style.transform = 'scale(0.9)';
            setTimeout(() => {
                win.remove();
                const appId = id.split('_')[0];
                if(!document.querySelector(`[id^="${appId}_"]`)) document.getElementById('task-'+appId).classList.remove('active');
            }, 200);
        }
        function minimizeWindow(id) { document.getElementById(id).style.display = 'none'; }
        function maximizeWindow(id) {
            const win = document.getElementById(id);
            if(win.style.width === '100%') {
                win.style.width = '800px'; win.style.height = '600px'; win.style.top = '50px'; win.style.left = '50px';
            } else {
                win.style.width = '100%'; win.style.height = '100%'; win.style.top = '0'; win.style.left = '0';
            }
        }

        // --- SHARED: SAVE FILE ---
        function saveFile(winId, type) {
            const container = document.getElementById(winId).querySelector('.window-content');
            let content = '';
            let ext = '';
            
            if(type==='word') { content = document.getElementById(`doc-${winId}`).innerHTML; ext='.docx'; }
            else if(type==='excel') { content = 'Spreadsheet Data'; ext='.xlsx'; }
            else if(type==='note') { content = document.getElementById(`note-${winId}`).value; ext='.txt'; }

            let filename = container.dataset.filename;
            if(!filename) {
                filename = prompt("שמור קובץ בשם:", "NewFile" + ext);
                if(!filename) return;
            }
            
            const path = ['Users', 'Admin', 'Documents']; 
            if(vfs.write(path, filename, content, type)) {
                alert('הקובץ נשמר בהצלחה בתיקיית Documents');
                container.dataset.filename = filename;
            } else { alert('שגיאה בשמירה'); }
        }

        // --- Apps Logic ---

        // 1. EXPLORER (Advanced)
        function initExplorer(c, id) {
            let currentPath = ['Users', 'Admin', 'Documents'];
            c.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-[#222] text-sm">
                    <div class="flex gap-2 p-2 border-b bg-gray-50 dark:bg-[#333] dark:border-gray-600">
                        <button class="px-3 py-1 bg-white border rounded hover:bg-gray-100" onclick="expAction('${id}', 'copy')"><i class="fas fa-copy"></i> העתק</button>
                        <button class="px-3 py-1 bg-white border rounded hover:bg-gray-100" onclick="expAction('${id}', 'cut')"><i class="fas fa-cut"></i> גזור</button>
                        <button class="px-3 py-1 bg-white border rounded hover:bg-gray-100" onclick="expAction('${id}', 'paste')"><i class="fas fa-paste"></i> הדבק</button>
                        <div class="flex-grow"></div>
                        <input class="w-1/3 border px-2 rounded bg-white" value="PC > Documents" id="exp-addr-${id}" readonly>
                    </div>
                    <div class="flex flex-grow overflow-hidden">
                        <div class="w-48 bg-gray-50 dark:bg-[#252525] border-l dark:border-gray-600 p-2 flex flex-col gap-1">
                            <div class="tree-node font-bold"><i class="fas fa-desktop text-blue-400"></i> שולחן העבודה</div>
                            <div class="tree-node font-bold cursor-pointer hover:bg-blue-100 rounded" onclick="expNav('${id}', ['Users','Admin','Documents'])"><i class="fas fa-file-alt text-yellow-500"></i> מסמכים</div>
                            <div class="tree-node font-bold cursor-pointer hover:bg-blue-100 rounded" onclick="expNav('${id}', ['Users','Admin','Pictures'])"><i class="fas fa-image text-purple-500"></i> תמונות</div>
                            <div class="tree-node font-bold cursor-pointer hover:bg-blue-100 rounded" onclick="expNav('${id}', ['Users','Admin','Downloads'])"><i class="fas fa-download text-green-500"></i> הורדות</div>
                        </div>
                        <div class="flex-grow p-4 grid grid-cols-6 gap-2 content-start" id="exp-grid-${id}"></div>
                    </div>
                    <div class="h-6 border-t bg-gray-50 px-2 text-xs flex items-center">פריטים: <span id="exp-count-${id}">0</span></div>
                </div>
            `;
            c.dataset.path = JSON.stringify(currentPath);
            renderExplorer(id);
        }

        window.expNav = (id, path) => {
            document.getElementById(id).querySelector('.window-content').dataset.path = JSON.stringify(path);
            renderExplorer(id);
        }
        
        window.expAction = (id, action) => {
            const path = JSON.parse(document.getElementById(id).querySelector('.window-content').dataset.path);
            const selected = document.querySelector(`#exp-grid-${id} .file-item.selected`);
            if(action === 'paste') {
                if(vfs.paste(path)) { renderExplorer(id); }
            } else if (selected) {
                const name = selected.querySelector('span').innerText;
                if(action === 'copy') vfs.copy(path, name);
                if(action === 'cut') vfs.cut(path, name);
            }
        };

        function renderExplorer(id) {
            const c = document.getElementById(id).querySelector('.window-content');
            const path = JSON.parse(c.dataset.path);
            const grid = document.getElementById(`exp-grid-${id}`);
            const dir = vfs.resolve(path);
            
            const addr = document.getElementById(`exp-addr-${id}`);
            if(addr) addr.value = path.join(' > ');

            grid.innerHTML = '';
            let count = 0;
            if(dir && dir.children) {
                Object.entries(dir.children).forEach(([name, data]) => {
                    count++;
                    const el = document.createElement('div');
                    el.className = 'file-item';
                    let icon = 'fa-file'; let color = 'text-gray-400';
                    if(data.type==='folder') { icon='fa-folder'; color='text-yellow-400'; }
                    else if(data.app==='word') { icon='fa-file-word'; color='text-blue-600'; }
                    else if(data.app==='excel') { icon='fa-file-excel'; color='text-green-600'; }
                    else if(data.app==='gallery') { icon='fa-image'; color='text-purple-600'; }
                    else if(data.app==='cmd') { icon='fa-cog'; color='text-gray-600'; }
                    
                    el.innerHTML = `<i class="fas ${icon} text-3xl ${color} mb-2"></i><span class="text-xs break-all leading-tight">${name}</span>`;
                    el.onclick = () => { 
                        document.querySelectorAll(`#exp-grid-${id} .file-item`).forEach(e=>e.classList.remove('selected'));
                        el.classList.add('selected');
                    };
                    el.ondblclick = () => {
                        if(data.type==='file') openWindow(data.app, data.content, name, path);
                        else if(data.type==='folder') expNav(id, [...path, name]);
                    };
                    grid.appendChild(el);
                });
            }
            document.getElementById(`exp-count-${id}`).innerText = count;
        }

        // 2. ANDROID ULTRA (Recreated)
        function initAndroid(c, id) {
            c.innerHTML = `
                <div class="android-frame">
                    <div class="android-screen">
                        <!-- Status Bar -->
                        <div class="flex justify-between px-3 py-1 text-white text-[10px] z-50 absolute w-full bg-black/20 top-0 left-0">
                            <span>12:00</span>
                            <div class="flex gap-1"><i class="fas fa-wifi"></i> <i class="fas fa-battery-full"></i></div>
                        </div>

                        <div class="flex-grow relative overflow-hidden flex flex-col pt-6 pb-12">
                            <!-- Home Screen -->
                            <div id="and-home-${id}" class="android-app active bg-[url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=400')] bg-cover text-white p-4 h-full absolute top-0 left-0">
                                <div class="mt-8 text-center text-4xl font-light drop-shadow">12:00</div>
                                <div class="text-center text-xs opacity-80 mb-auto">Sunday, Jan 1</div>
                                <div class="grid grid-cols-4 gap-4 mt-auto mb-4 absolute bottom-4 w-full px-4 left-0">
                                    ${appIcon('phone', 'bg-green-500', 'fas fa-phone', id, 'phone')}
                                    ${appIcon('msg', 'bg-blue-500', 'fas fa-comment', id, 'msg')}
                                    ${appIcon('gallery', 'bg-purple-500', 'fas fa-images', id, 'gallery')}
                                    ${appIcon('browser', 'bg-orange-500', 'fab fa-chrome', id, 'browser')}
                                </div>
                            </div>

                            <!-- Apps -->
                            <!-- Phone -->
                            <div id="and-phone-${id}" class="android-app absolute top-0 left-0 h-full bg-white">
                                <div class="bg-gray-100 p-2 font-bold text-gray-800 text-center shadow pt-8">Phone</div>
                                <div class="flex-grow flex flex-col items-center justify-center relative">
                                    <div id="call-overlay-${id}" class="absolute w-full h-full bg-black/90 text-white flex flex-col items-center justify-center z-20 hidden">
                                        <div class="w-20 h-20 rounded-full bg-gray-700 flex items-center justify-center text-3xl mb-4 animate-[pulse-ring_2s_infinite]"><i class="fas fa-user"></i></div>
                                        <div class="text-xl">Calling...</div>
                                        <div class="text-sm opacity-70 mb-8" id="call-num-${id}"></div>
                                        <button class="w-16 h-16 rounded-full bg-red-600 text-white" onclick="endCall('${id}')"><i class="fas fa-phone-slash"></i></button>
                                    </div>
                                    <div class="text-3xl mb-8 border-b w-3/4 text-center py-2 text-gray-700 h-12" id="dial-disp-${id}"></div>
                                    <div class="grid grid-cols-3 gap-6 text-2xl font-light text-gray-700">
                                        ${[1,2,3,4,5,6,7,8,9,'*',0,'#'].map(n => `<div class="cursor-pointer hover:bg-gray-200 w-12 h-12 rounded-full flex items-center justify-center" onclick="dial('${id}','${n}')">${n}</div>`).join('')}
                                    </div>
                                    <button class="w-16 h-16 rounded-full bg-green-500 text-white text-2xl mt-8 shadow-lg" onclick="startCall('${id}')"><i class="fas fa-phone"></i></button>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div id="and-msg-${id}" class="android-app bg-white flex flex-col absolute top-0 left-0 h-full">
                                <div class="bg-blue-600 p-3 text-white font-bold shadow pt-8">Messages</div>
                                <div class="flex-grow p-2 overflow-y-auto flex flex-col gap-2 bg-gray-50" id="msg-list-${id}">
                                    <div class="bg-gray-200 p-2 rounded-lg self-start max-w-[80%] text-sm">Welcome to Android!</div>
                                </div>
                                <div class="p-2 border-t flex gap-2 bg-white">
                                    <input id="msg-in-${id}" class="flex-grow border rounded-full px-3 text-sm" placeholder="Text message">
                                    <button class="text-blue-600" onclick="sendMsg('${id}')"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>

                            <!-- Gallery -->
                            <div id="and-gallery-${id}" class="android-app bg-black text-white p-2 grid grid-cols-3 gap-1 content-start overflow-y-auto absolute top-0 left-0 h-full pt-8">
                                <div class="col-span-3 text-center text-lg font-bold py-2">Gallery</div>
                                ${Array(12).fill(0).map((_,i) => `<div class="aspect-square bg-gray-800 rounded overflow-hidden"><img src="https://picsum.photos/100?random=${i}" class="w-full h-full object-cover"></div>`).join('')}
                            </div>

                            <!-- Browser -->
                            <div id="and-browser-${id}" class="android-app flex flex-col absolute top-0 left-0 h-full bg-white">
                                <div class="bg-gray-200 p-2 flex gap-2 items-center text-xs pt-8 border-b">
                                    <div class="bg-white flex-grow rounded px-2 py-1 flex items-center gap-2"><i class="fas fa-lock text-green-600"></i> google.com</div>
                                </div>
                                <div class="flex-grow flex flex-col items-center justify-center p-4">
                                    <span class="text-4xl font-bold mb-4"><span class="text-blue-500">G</span><span class="text-red-500">o</span><span class="text-yellow-500">o</span><span class="text-blue-500">g</span><span class="text-green-500">l</span><span class="text-red-500">e</span></span>
                                    <input class="border rounded-full px-4 py-2 w-full shadow-inner" placeholder="Search">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nav Bar (Fixed Bottom) -->
                        <div class="bg-black py-3 flex justify-around text-gray-400 z-50 absolute bottom-0 left-0 w-full h-12 items-center">
                            <i class="fas fa-bars cursor-pointer text-lg hover:text-white"></i>
                            <i class="fas fa-square cursor-pointer text-lg hover:text-white" onclick="goHome('${id}')"></i>
                            <i class="fas fa-arrow-left cursor-pointer text-lg hover:text-white" onclick="goHome('${id}')"></i>
                        </div>
                    </div>
                </div>
            `;
        }
        function appIcon(target, color, icon, id, name) {
            return `<div class="flex flex-col items-center gap-1 cursor-pointer" onclick="openApp('${id}', '${target}')">
                <div class="w-12 h-12 ${color} rounded-xl flex items-center justify-center text-white text-xl shadow"><i class="${icon}"></i></div>
                <div class="text-[10px] text-white shadow-black">${name}</div>
            </div>`;
        }
        window.openApp = (winId, app) => {
            document.querySelectorAll(`#${winId} .android-app`).forEach(el => el.classList.remove('active'));
            document.getElementById(`and-${app}-${winId}`).classList.add('active');
        };
        window.goHome = (winId) => {
            document.querySelectorAll(`#${winId} .android-app`).forEach(el => el.classList.remove('active'));
            document.getElementById(`and-home-${winId}`).classList.add('active');
        };
        window.dial = (id, n) => document.getElementById(`dial-disp-${id}`).innerText += n;
        window.startCall = (id) => {
            const num = document.getElementById(`dial-disp-${id}`).innerText;
            if(!num) return;
            document.getElementById(`call-num-${id}`).innerText = num;
            document.getElementById(`call-overlay-${id}`).classList.remove('hidden');
            document.getElementById(`call-overlay-${id}`).classList.add('flex');
        };
        window.endCall = (id) => {
            document.getElementById(`call-overlay-${id}`).classList.add('hidden');
            document.getElementById(`call-overlay-${id}`).classList.remove('flex');
            document.getElementById(`dial-disp-${id}`).innerText = '';
        };
        window.sendMsg = (id) => {
            const inp = document.getElementById(`msg-in-${id}`);
            if(!inp.value) return;
            const list = document.getElementById(`msg-list-${id}`);
            list.innerHTML += `<div class="bg-blue-500 text-white p-2 rounded-lg self-end max-w-[80%] text-sm">${inp.value}</div>`;
            inp.value = '';
        };

        // 3. MAC OS (Functional)
        function initMac(c, id) {
            c.innerHTML = `
                <div class="mac-frame">
                    <div class="bg-gray-100/90 h-6 flex items-center px-4 text-xs font-semibold gap-4 z-10 border-b shadow-sm">
                        <i class="fab fa-apple"></i>
                        <span>Finder</span>
                        <span>File</span>
                        <span>Edit</span>
                        <span>View</span>
                        <span>Go</span>
                        <div class="ml-auto flex gap-3">
                            <i class="fas fa-search"></i>
                            <i class="fas fa-wifi"></i>
                            <span>Sun 12:00</span>
                        </div>
                    </div>
                    <div class="mac-desktop" id="mac-desk-${id}">
                        <div id="mac-safari-${id}" class="mac-window-vm w-[500px] h-[350px] top-[40px] left-[50px]">
                            <div class="bg-gray-200 p-2 flex gap-2 items-center border-b">
                                <div class="flex gap-2 mr-2">
                                    <div class="w-3 h-3 rounded-full bg-red-500 cursor-pointer" onclick="this.closest('.mac-window-vm').style.display='none'"></div>
                                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                </div>
                                <div class="bg-white flex-grow rounded text-center text-xs text-gray-500 py-0.5">apple.com</div>
                            </div>
                            <div class="flex-grow bg-white flex flex-col items-center justify-center">
                                <i class="fab fa-apple text-6xl text-gray-800 mb-4"></i>
                                <h1 class="text-2xl font-bold">MacBook Pro</h1>
                                <button class="mt-4 bg-blue-600 text-white px-4 py-1 rounded-full text-sm">Buy</button>
                            </div>
                        </div>
                        <div id="mac-term-${id}" class="mac-window-vm w-[400px] h-[300px] top-[100px] left-[200px] bg-[#1e1e1e] text-white font-mono text-sm border-none shadow-2xl">
                            <div class="bg-[#333] p-2 flex gap-2 items-center border-b border-gray-600">
                                <div class="flex gap-2 mr-2">
                                    <div class="w-3 h-3 rounded-full bg-red-500 cursor-pointer" onclick="this.closest('.mac-window-vm').style.display='none'"></div>
                                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                </div>
                                <div class="text-xs text-gray-400 mx-auto">user — -zsh</div>
                            </div>
                            <div class="p-2">
                                <div>Last login: Sun Jan 1 on ttys000</div>
                                <div>user@macbook % <span class="animate-pulse">_</span></div>
                            </div>
                        </div>
                         <div class="mac-dock">
                            <div class="mac-dock-icon bg-blue-500 text-white"><i class="fas fa-smile"></i></div>
                            <div class="mac-dock-icon bg-white text-blue-500" onclick="toggleMacWin('${id}', 'safari')"><i class="fab fa-safari"></i></div>
                            <div class="mac-dock-icon bg-black text-white" onclick="toggleMacWin('${id}', 'term')"><i class="fas fa-terminal"></i></div>
                            <div class="mac-dock-icon bg-yellow-400 text-white"><i class="fas fa-sticky-note"></i></div>
                            <div class="w-px h-8 bg-white/20 mx-1"></div>
                            <div class="mac-dock-icon bg-gray-500 text-white"><i class="fas fa-trash"></i></div>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                c.querySelectorAll('.mac-window-vm').forEach(w => {
                    const h = w.firstElementChild;
                    h.onmousedown = (e) => {
                         let shiftX = e.clientX - w.getBoundingClientRect().left;
                         let shiftY = e.clientY - w.getBoundingClientRect().top;
                         const desk = document.getElementById(`mac-desk-${id}`);
                         const deskRect = desk.getBoundingClientRect();
                         function moveAt(pageX, pageY) {
                             w.style.left = (pageX - shiftX - deskRect.left) + 'px';
                             w.style.top = (pageY - shiftY - deskRect.top) + 'px';
                         }
                         function onMove(ev) { moveAt(ev.pageX, ev.pageY); }
                         function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
                         document.addEventListener('mousemove', onMove);
                         document.addEventListener('mouseup', onUp);
                    };
                });
            }, 500);
        }
        window.toggleMacWin = (id, app) => {
            const el = document.getElementById(`mac-${app}-${id}`);
            if(el) {
                el.style.display = el.style.display === 'none' ? 'flex' : 'none';
                el.style.zIndex = 50;
            }
        }

        // 4. WORD (Functional)
        function initWord(c, id, content, filename) {
            c.dataset.filename = filename || '';
            c.innerHTML = `
                <div class="flex flex-col h-full bg-gray-100 dark:bg-[#333]">
                    <div class="bg-[#2b579a] text-white px-2 py-1 text-xs flex gap-4">
                        <span class="cursor-pointer hover:bg-white/20 px-2 rounded" onclick="saveFile('${id}', 'word')"><i class="fas fa-save"></i> שמור</span>
                        <span>בית</span> <span>הוספה</span> <span>תצוגה</span>
                    </div>
                    <div class="ribbon bg-white dark:bg-[#444] text-xs">
                        <div class="ribbon-btn" onclick="document.execCommand('bold')"><i class="fas fa-bold"></i> מודגש</div>
                        <div class="ribbon-btn" onclick="document.execCommand('italic')"><i class="fas fa-italic"></i> נטוי</div>
                        <div class="ribbon-btn" onclick="document.execCommand('underline')"><i class="fas fa-underline"></i> קו</div>
                        <div class="ribbon-sep"></div>
                        <div class="ribbon-btn" onclick="document.execCommand('justifyLeft')"><i class="fas fa-align-left"></i></div>
                        <div class="ribbon-btn" onclick="document.execCommand('justifyCenter')"><i class="fas fa-align-center"></i></div>
                        <div class="ribbon-btn" onclick="document.execCommand('justifyRight')"><i class="fas fa-align-right"></i></div>
                        <div class="ribbon-sep"></div>
                        <div class="ribbon-btn" onclick="document.execCommand('foreColor', false, 'red')"><i class="fas fa-font text-red-500"></i></div>
                        <div class="ribbon-btn" onclick="document.execCommand('foreColor', false, 'blue')"><i class="fas fa-font text-blue-500"></i></div>
                    </div>
                    <div class="flex-grow bg-gray-200 dark:bg-[#222] overflow-auto p-8 flex justify-center">
                        <div id="doc-${id}" class="bg-white w-[21cm] min-h-[29.7cm] shadow-xl p-[2.5cm] outline-none text-right text-black" contenteditable="true">
                            ${content || '<h1 class="text-2xl font-bold mb-4 text-[#2b579a]">מסמך חדש</h1><p>התחל להקליד...</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // 5. EXCEL (Functional)
        function initExcel(c, id) {
            c.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-[#333] text-sm">
                    <div class="bg-[#217346] text-white px-2 py-1 text-xs"><button onclick="saveFile('${id}','excel')"><i class="fas fa-save"></i> שמור</button></div>
                    <div class="ribbon bg-white dark:bg-[#444]">
                        <div class="ribbon-btn"><i class="fas fa-paste"></i> הדבק</div>
                        <div class="ribbon-btn"><i class="fas fa-copy"></i> העתק</div>
                        <div class="ribbon-sep"></div>
                        <div class="ribbon-btn font-bold">B</div>
                        <div class="ribbon-btn italic">I</div>
                    </div>
                    <div class="flex items-center border-b p-1 bg-gray-100 dark:bg-[#333] dark:border-gray-600">
                        <div class="w-10 text-center border bg-white dark:bg-[#444] dark:border-gray-500 mr-2 text-xs py-1">A1</div>
                        <input type="text" class="flex-grow border px-2 py-1 text-xs dark:bg-[#444] dark:border-gray-500 dark:text-white" placeholder="fx">
                    </div>
                    <div class="flex-grow overflow-auto grid grid-cols-[40px_repeat(10,100px)]">
                        <div class="bg-gray-100 border-b border-r dark:bg-[#444]"></div>
                        ${Array.from({length:10},(_,i)=>`<div class="bg-gray-100 border-b border-r text-center text-xs p-1 font-bold dark:bg-[#444]">${String.fromCharCode(65+i)}</div>`).join('')}
                        ${Array.from({length:30},(_,r)=>
                            `<div class="bg-gray-100 border-b border-r text-center text-xs p-1 dark:bg-[#444]">${r+1}</div>` +
                            Array.from({length:10},()=>`<input class="border-b border-r text-xs p-1 outline-none focus:border-green-500 focus:border-2 dark:bg-[#222] dark:text-white">`).join('')
                        ).join('')}
                    </div>
                </div>`;
        }

        // 6. NOTEPAD
        function initNotepad(c, id, content, filename) {
            c.dataset.filename = filename || '';
            c.innerHTML = `<div class="h-full flex flex-col bg-white"><div class="border-b p-1 text-xs"><button onclick="saveFile('${id}','note')">שמור</button></div><textarea id="note-${id}" class="flex-grow p-2 outline-none resize-none font-mono text-sm">${content || ''}</textarea></div>`;
        }

        // 7. SETTINGS (Restored)
        function initSettings(c) {
            c.innerHTML = `
                <div class="flex h-full text-sm select-none">
                    <div class="w-1/4 border-l border-gray-300/20 p-2 flex flex-col gap-1 bg-gray-50/50 dark:bg-gray-800/50">
                        <div class="p-3 flex items-center gap-3 mb-2">
                             <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">A</div>
                             <div><div class="font-bold">Admin</div><div class="text-xs opacity-60">Local Account</div></div>
                        </div>
                        <input type="text" placeholder="חיפוש בהגדרות" class="mb-4 p-2 rounded border bg-white/50 w-full">
                        ${['מערכת', 'Bluetooth והתקנים', 'רשת ואינטרנט', 'התאמה אישית', 'אפליקציות', 'חשבונות', 'זמן ושפה', 'משחקים', 'נגישות', 'Windows Update'].map((item, i) => 
                            `<div class="p-2 rounded hover:bg-black/5 cursor-pointer flex items-center gap-3 ${i===0?'bg-white shadow-sm':''}">
                                <i class="fas fa-${['laptop','bluetooth','wifi','paint-brush','th','user','clock','gamepad','universal-access','sync'][i]} w-5 text-center text-blue-500"></i> ${item}
                            </div>`
                        ).join('')}
                    </div>
                    <div class="w-3/4 p-6 overflow-auto bg-white/80 dark:bg-[#202020]/90">
                        <h2 class="text-2xl font-bold mb-6">מערכת</h2>
                        <div class="mb-6 p-4 bg-white/50 dark:bg-white/5 rounded-lg border border-gray-200/50">
                            <div class="flex items-center gap-3 mb-4"><i class="fas fa-sun text-xl"></i> <span class="font-bold">תצוגה</span></div>
                            <div class="flex items-center justify-between mb-2">
                                <span>בהירות</span>
                                <input type="range" min="20" max="100" value="${systemState.brightness}" oninput="setBrightness(this.value)" class="w-48">
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold mb-6 mt-8">התאמה אישית</h2>
                        <div class="font-bold mb-2">רקע לשולחן העבודה</div>
                        <div class="grid grid-cols-3 gap-3">
                             ${['https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80',
                                'https://images.unsplash.com/photo-1477346611705-65d1883cee1e?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80',
                                'https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80',
                                'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80'].map(url => 
                                 `<div class="aspect-video rounded overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-500" onclick="setWall('${url.split('?')[0]}')">
                                    <img src="${url}" class="w-full h-full object-cover">
                                 </div>`
                             ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // 8. CMD (Restored)
        function initCMD(c, id) {
            c.innerHTML = `
                <div class="bg-black text-gray-300 font-mono text-sm h-full p-2 overflow-auto" onclick="document.getElementById('cmd-in-${id}').focus()">
                    <div>Microsoft Windows [Version 12.0.22621.1]<br>(c) Microsoft Corporation. All rights reserved.</div><br>
                    <div id="cmd-out-${id}"></div>
                    <div class="flex">
                        <span class="mr-2 text-white">C:\\Users\\Admin></span>
                        <input id="cmd-in-${id}" class="bg-transparent border-none outline-none text-white flex-grow font-mono" autocomplete="off" onkeydown="handleCMD(event, '${id}')">
                    </div>
                </div>
            `;
        }
        window.handleCMD = (e, id) => {
            if(e.key === 'Enter') {
                const val = e.target.value;
                const out = document.getElementById(`cmd-out-${id}`);
                out.innerHTML += `<div><span class="text-white">C:\\Users\\Admin></span> ${val}</div>`;
                if(val === 'dir') out.innerHTML += `<div>01/01/2025 <DIR> Documents<br>01/01/2025 <DIR> Downloads</div>`;
                else if(val === 'cls') out.innerHTML = '';
                else if(val === 'help') out.innerHTML += `<div>Commands: dir, cls, echo, exit, help</div>`;
                else out.innerHTML += `<div class="text-red-400">'${val}' is not recognized.</div>`;
                e.target.value = '';
                e.target.parentElement.parentElement.scrollTop = 99999;
            }
        }

        // 9. POWERPOINT (Restored)
        let pptSlides = [{title: "כותרת ראשית", sub: "כותרת משנה"}, {title: "תוכן העניינים", sub: "נקודה 1\nנקודה 2"}];
        function initPPT(c, id) {
            c.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-[#333]">
                    <div class="bg-[#b7472a] text-white px-2 py-1 text-xs">PowerPoint</div>
                    <div class="ribbon bg-white dark:bg-[#444]">
                        <div class="ribbon-btn" onclick="addSlide('${id}')"><i class="fas fa-plus-square text-orange-600"></i> שקופית חדשה</div>
                        <div class="ribbon-sep"></div>
                        <div class="ribbon-btn"><i class="fas fa-image"></i> תמונה</div>
                        <div class="ribbon-btn"><i class="fas fa-shapes"></i> צורות</div>
                        <div class="ml-auto ribbon-btn" onclick="alert('מצגת מתחילה...')"><i class="fas fa-play text-green-600"></i> הצג</div>
                    </div>
                    <div class="flex flex-grow overflow-hidden">
                        <div class="w-40 bg-gray-100 dark:bg-[#2a2a2a] border-l dark:border-gray-600 p-2 overflow-y-auto flex flex-col gap-2" id="ppt-sidebar-${id}"></div>
                        <div class="flex-grow bg-gray-200 dark:bg-[#202020] p-8 flex items-center justify-center">
                            <div class="bg-white aspect-video w-full shadow-2xl p-8 flex flex-col justify-center items-center text-center select-text" id="ppt-stage-${id}" contenteditable="true"></div>
                        </div>
                    </div>
                </div>
            `;
            renderPPT(id, 0);
        }
        window.addSlide = (id) => { pptSlides.push({title: "שקופית חדשה", sub: "הוסף טקסט"}); renderPPT(id, pptSlides.length-1); };
        window.renderPPT = (id, idx) => {
            const sb = document.getElementById(`ppt-sidebar-${id}`);
            const st = document.getElementById(`ppt-stage-${id}`);
            if(!sb || !st) return;
            sb.innerHTML = pptSlides.map((s, i) => `
                <div class="aspect-video bg-white border ${i===idx?'border-orange-500 ring-2 ring-orange-200':''} shadow-sm p-1 text-[5px] cursor-pointer overflow-hidden" onclick="renderPPT('${id}', ${i})">
                    <div class="font-bold">${s.title}</div><div>${s.sub}</div>
                </div>
            `).join('');
            st.innerHTML = `
                <h1 class="text-4xl font-bold mb-4 text-gray-800 border border-dashed border-transparent hover:border-gray-400 p-2 w-full">${pptSlides[idx].title}</h1>
                <div class="text-xl text-gray-500 w-full border border-dashed border-transparent hover:border-gray-400 p-2 whitespace-pre-wrap">${pptSlides[idx].sub}</div>
            `;
        }

        // Helpers
        window.setBrightness = (val) => {
            systemState.brightness = val;
            document.getElementById('brightness-overlay').style.opacity = (100 - val) / 100;
        }
        window.setWall = (url) => {
            document.getElementById('wallpaper').style.backgroundImage = `url('${url}')`;
        }
        function systemAction(act) {
            const boot = document.getElementById('boot-screen');
            const txt = document.getElementById('boot-text');
            const load = document.getElementById('boot-loader');
            
            boot.style.display = 'flex';
            boot.style.opacity = '1';
            
            if(act === 'restart') {
                txt.innerText = 'מפעיל מחדש...';
            } else {
                txt.innerText = 'מכבה...';
                setTimeout(() => { load.style.display = 'none'; txt.innerText = 'המחשב כבוי כעת. רענן את הדף להפעלה.'; }, 3000);
                return;
            }
            setTimeout(() => location.reload(), 3000);
        }

    </script>
</body>
</html>
