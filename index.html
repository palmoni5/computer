<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 12 Ultra Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- Core System --- */
        body {
            overflow: hidden;
            font-family: 'Segoe UI Variable', 'Segoe UI', Tahoma, sans-serif;
            user-select: none;
            margin: 0; padding: 0;
            background: #000;
            cursor: default;
        }

        /* --- Glassmorphism & Visuals --- */
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .glass-dark {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Animations */
        @keyframes bootUp { 0% { opacity: 0; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes winPop { 0% { transform: scale(0.95) translateY(10px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%) translateX(-50%); } to { transform: translateY(0) translateX(-50%); } }

        /* Wallpaper */
        .desktop-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: background-image 0.5s ease-in-out;
            z-index: 0;
        }

        /* --- Window System --- */
        .window {
            position: absolute;
            border-radius: 12px;
            display: flex; flex-direction: column;
            overflow: hidden;
            min-width: 300px; min-height: 200px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: winPop 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            resize: both;
        }
        .window-header {
            padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: default; /* Logic handles dragging */
            background: rgba(255,255,255,0.4);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .window-content { flex-grow: 1; position: relative; overflow: auto; background: rgba(255,255,255,0.9); }

        /* Desktop Icons */
        .desktop-icon {
            position: absolute;
            width: 86px; height: 96px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; transition: background 0.2s;
            color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            cursor: pointer;
        }
        .desktop-icon:hover { background: rgba(255,255,255,0.15); backdrop-filter: blur(4px); }
        .desktop-icon.selected { background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.3); }

        /* Floating Taskbar (Windows 12 Style) */
        .taskbar-container {
            position: absolute; bottom: 12px; left: 0; width: 100%;
            display: flex; justify-content: center;
            z-index: 9000;
        }
        .taskbar {
            height: 56px;
            display: flex; align-items: center; gap: 8px;
            padding: 0 16px;
            border-radius: 100px; /* Pill shape */
            transition: all 0.3s;
        }
        .task-icon {
            width: 42px; height: 42px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            position: relative;
        }
        .task-icon:hover { background: rgba(255,255,255,0.3); transform: translateY(-3px); }
        .task-icon.active::after {
            content: ''; position: absolute; bottom: -6px; width: 6px; height: 6px;
            background: #3b82f6; border-radius: 50%;
        }
        .task-icon img, .task-icon i { font-size: 24px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }

        /* Start Menu (Floating) */
        .start-menu {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 640px; height: 450px;
            border-radius: 16px;
            display: none; flex-direction: column;
            z-index: 9001;
            padding: 24px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .start-menu.active { display: flex; }

        /* File Explorer Tree */
        .tree-node { padding: 4px 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; border-radius: 4px; font-size: 13px; color: #444; }
        .tree-node:hover { background: rgba(0,0,0,0.05); }
        .tree-node.active { background: #e0e7ff; color: #3730a3; font-weight: 600; }
        .file-grid-item { 
            display: flex; flex-direction: column; align-items: center; gap: 4px; 
            padding: 10px; border-radius: 6px; cursor: pointer; 
            width: 90px; text-align: center;
        }
        .file-grid-item:hover { background: rgba(0,0,0,0.05); }
        .file-grid-item.selected { background: #e0e7ff; border: 1px solid #c7d2fe; }

        /* System Overlay */
        .system-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            background: #000; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

    </style>
</head>
<body oncontextmenu="return false;">

    <!-- Boot Screen -->
    <div id="boot-screen" class="system-overlay">
        <div class="mb-8 relative w-24 h-24 flex items-center justify-center">
            <div class="absolute w-full h-full border-4 border-blue-500/30 rounded-full animate-ping"></div>
            <i class="fab fa-windows text-6xl text-blue-500 relative z-10"></i>
        </div>
        <div class="text-2xl font-light tracking-widest mb-2">WINDOWS 12</div>
        <div class="text-sm text-gray-500">Ultra Experience</div>
        <div class="mt-8 w-48 h-1 bg-gray-800 rounded overflow-hidden">
            <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-1/2 animate-[spin_2s_linear_infinite] origin-left"></div>
        </div>
    </div>

    <!-- Main Desktop -->
    <div id="desktop-env" style="display: none; height: 100vh; position: relative; overflow: hidden;">
        <!-- Dynamic Background -->
        <div id="wallpaper" class="desktop-bg" style="background-image: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');"></div>

        <!-- Desktop Icons Layer -->
        <div id="desktop-icons-layer" class="absolute top-0 left-0 w-full h-full z-10">
            <!-- Icons injected via JS -->
        </div>

        <!-- Windows Layer -->
        <div id="windows-container" class="absolute top-0 left-0 w-full h-full z-20 pointer-events-none">
            <!-- Windows injected via JS -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="start-menu glass">
            <div class="flex-grow">
                <div class="bg-white/50 rounded-full px-4 py-2 flex items-center gap-2 mb-6 shadow-sm">
                    <i class="fas fa-search text-gray-500"></i>
                    <input type="text" placeholder="חיפוש באפליקציות, הגדרות ומסמכים" class="bg-transparent border-none outline-none w-full text-sm">
                </div>
                <div class="text-xs font-bold text-gray-500 mb-3 px-2">ננעצו</div>
                <div class="grid grid-cols-6 gap-4" id="start-pinned">
                    <!-- Pinned Apps JS -->
                </div>
                <div class="text-xs font-bold text-gray-500 mt-6 mb-3 px-2">מומלצים</div>
                <div class="grid grid-cols-2 gap-2" id="start-recommended">
                    <!-- Recent Files JS -->
                </div>
            </div>
            <div class="border-t border-gray-300/30 pt-4 flex justify-between items-center px-2 mt-2">
                <div class="flex items-center gap-3 cursor-pointer hover:bg-white/30 p-2 rounded-lg transition">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center text-white text-xs">A</div>
                    <span class="text-sm font-semibold text-gray-800">Admin User</span>
                </div>
                <button onclick="systemAction('shutdown')" class="w-8 h-8 rounded hover:bg-red-100 text-gray-600 hover:text-red-600 flex items-center justify-center transition"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <!-- Floating Taskbar -->
        <div class="taskbar-container">
            <div class="taskbar glass">
                <div class="task-icon" onclick="toggleStartMenu()"><i class="fab fa-windows text-blue-600 text-2xl"></i></div>
                <div class="w-px h-6 bg-gray-400/30 mx-1"></div>
                <div id="taskbar-apps" class="flex gap-2"></div>
                <div class="w-px h-6 bg-gray-400/30 mx-1"></div>
                <!-- System Tray -->
                <div class="flex items-center gap-3 px-2 text-gray-700 text-xs cursor-pointer hover:bg-white/20 rounded px-2 py-1" onclick="openWindow('settings')">
                    <div class="flex flex-col items-end leading-none">
                        <span id="clock-time" class="font-bold">12:00</span>
                        <span id="clock-date">01/01</span>
                    </div>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-volume-up"></i>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Virtual File System Core ---
        class VirtualFileSystem {
            constructor() {
                this.root = {
                    type: 'folder',
                    name: 'C:',
                    children: {
                        'Users': {
                            type: 'folder',
                            children: {
                                'Admin': {
                                    type: 'folder',
                                    children: {
                                        'Desktop': { type: 'folder', children: {} },
                                        'Documents': { 
                                            type: 'folder', 
                                            children: {
                                                'Project.docx': { type: 'file', content: 'Project Alpha Proposal...', app: 'word' },
                                                'Budget.xlsx': { type: 'file', content: 'Q1: 5000\nQ2: 7000', app: 'excel' }
                                            } 
                                        },
                                        'Pictures': { type: 'folder', children: {} },
                                        'Downloads': { type: 'folder', children: {} }
                                    }
                                }
                            }
                        },
                        'Windows': { type: 'folder', children: {} }
                    }
                };
                this.currentPath = ['Users', 'Admin', 'Documents']; // Default path for explorer
            }

            // Navigate to path array, return node
            resolvePath(pathArray) {
                let current = this.root;
                for (let p of pathArray) {
                    if (current.children && current.children[p]) {
                        current = current.children[p];
                    } else {
                        return null;
                    }
                }
                return current;
            }

            writeFile(pathArray, filename, content, appType) {
                const folder = this.resolvePath(pathArray);
                if (folder && folder.type === 'folder') {
                    folder.children[filename] = { type: 'file', content: content, app: appType };
                    return true;
                }
                return false;
            }

            listFiles(pathArray) {
                const folder = this.resolvePath(pathArray);
                return folder ? folder.children : {};
            }
        }

        // --- System State ---
        const vfs = new VirtualFileSystem();
        let zIndex = 100;
        let activeWindows = {};
        
        // Settings Data
        const wallpapers = [
            'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80', // Abstract
            'https://images.unsplash.com/photo-1477346611705-65d1883cee1e?auto=format&fit=crop&w=1920&q=80', // Dark Mountain
            'https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80', // Landscape
            'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80', // Neon
            'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80'  // Clean Light
        ];

        // Apps Definition
        const apps = [
            { id: 'explorer', name: 'סייר הקבצים', icon: 'fa-folder-open', color: 'text-yellow-500', w: 800, h: 500, init: initExplorer },
            { id: 'word', name: 'Word', icon: 'fa-file-word', color: 'text-blue-600', w: 800, h: 600, init: initWord },
            { id: 'excel', name: 'Excel', icon: 'fa-file-excel', color: 'text-green-600', w: 800, h: 600, init: initExcel },
            { id: 'settings', name: 'הגדרות', icon: 'fa-cog', color: 'text-gray-500', w: 700, h: 500, init: initSettings },
            { id: 'cmd', name: 'Terminal', icon: 'fa-terminal', color: 'text-gray-800', w: 600, h: 400, init: initCMD },
            { id: 'notes', name: 'פנקס', icon: 'fa-sticky-note', color: 'text-yellow-600', w: 400, h: 300, init: initNotepad },
            { id: 'chrome', name: 'Edge', icon: 'fab fa-edge', color: 'text-blue-400', w: 900, h: 600, content: '<div class="h-full bg-white flex flex-col"><div class="bg-gray-100 p-2 border-b flex gap-2"><input class="flex-grow rounded-full px-4 py-1 text-sm border shadow-sm" value="https://bing.com"></div><iframe src="about:blank" class="flex-grow"></iframe></div>' }
        ];

        // --- Init ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('boot-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('boot-screen').style.display = 'none';
                    document.getElementById('desktop-env').style.display = 'block';
                    initDesktop();
                }, 1000);
            }, 2500);
        };

        function initDesktop() {
            renderDesktopIcons();
            renderTaskbar();
            renderStartMenu();
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock-time').innerText = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
                document.getElementById('clock-date').innerText = now.toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'});
            }, 1000);
        }

        // --- Desktop Icons & Dragging ---
        const desktopLayout = [
            { id: 'd_pc', app: 'explorer', label: 'מחשב זה', icon: 'fa-desktop', color: 'text-blue-400', top: 20, right: 20 },
            { id: 'd_bin', app: null, label: 'סל מחזור', icon: 'fa-trash', color: 'text-gray-400', top: 130, right: 20 },
            { id: 'd_word', app: 'word', label: 'Word', icon: 'fa-file-word', color: 'text-blue-600', top: 20, right: 120 },
            { id: 'd_set', app: 'settings', label: 'הגדרות', icon: 'fa-cog', color: 'text-gray-300', top: 130, right: 120 },
            { id: 'd_cmd', app: 'cmd', label: 'Terminal', icon: 'fa-terminal', color: 'text-black', top: 240, right: 20 }
        ];

        function renderDesktopIcons() {
            const container = document.getElementById('desktop-icons-layer');
            container.innerHTML = '';
            desktopLayout.forEach(item => {
                const el = document.createElement('div');
                el.className = 'desktop-icon';
                el.style.top = item.top + 'px';
                el.style.right = item.right + 'px'; // RTL
                el.innerHTML = `<i class="fas ${item.icon} text-4xl mb-2 ${item.color}" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));"></i><span class="text-xs text-center font-medium shadow-black">${item.label}</span>`;
                
                // Drag Logic
                el.onmousedown = (e) => {
                    if(e.button !== 0) return; // Only left click
                    el.classList.add('selected');
                    let shiftX = e.clientX - el.getBoundingClientRect().left;
                    let shiftY = e.clientY - el.getBoundingClientRect().top;
                    
                    function moveAt(pageX, pageY) {
                        el.style.top = Math.max(0, Math.min(window.innerHeight-100, pageY - shiftY)) + 'px';
                        el.style.right = 'auto'; // Switch to left positioning for drag simplicity
                        el.style.left = Math.max(0, Math.min(window.innerWidth-100, pageX - shiftX)) + 'px';
                    }

                    function onMouseMove(event) { moveAt(event.pageX, event.pageY); }

                    document.addEventListener('mousemove', onMouseMove);
                    el.onmouseup = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        el.onmouseup = null;
                        el.classList.remove('selected');
                    };
                };

                el.ondblclick = () => { if(item.app) openWindow(item.app); };
                container.appendChild(el);
            });
        }

        // --- Taskbar & Start Menu ---
        function renderTaskbar() {
            const container = document.getElementById('taskbar-apps');
            container.innerHTML = '';
            apps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'task-icon';
                div.id = 'task-' + app.id;
                div.onclick = () => openWindow(app.id);
                div.innerHTML = `<i class="fas ${app.icon} ${app.color.replace('text-', 'text-')}"></i>`; // Simplified color mapping
                // Use FA color directly
                div.querySelector('i').className += ` ${app.color}`;
                container.appendChild(div);
            });
        }

        function renderStartMenu() {
            const pinned = document.getElementById('start-pinned');
            const rec = document.getElementById('start-recommended');
            
            // Render Pinned
            apps.forEach(app => {
                const el = document.createElement('div');
                el.className = 'flex flex-col items-center gap-2 cursor-pointer p-2 hover:bg-white/40 rounded-lg transition';
                el.onclick = () => { openWindow(app.id); toggleStartMenu(); };
                el.innerHTML = `<i class="fas ${app.icon} text-2xl ${app.color}"></i><span class="text-xs text-gray-700">${app.name}</span>`;
                pinned.appendChild(el);
            });

            // Mock Recommended
            const recFiles = [
                { name: 'Project_Alpha.docx', icon: 'fa-file-word text-blue-600', time: 'לפני 2 דקות' },
                { name: 'Q3_Budget.xlsx', icon: 'fa-file-excel text-green-600', time: 'לפני שעה' },
                { name: 'Design_System.pdf', icon: 'fa-file-pdf text-red-500', time: 'אתמול' }
            ];
            recFiles.forEach(f => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-3 p-2 hover:bg-white/40 rounded-lg cursor-pointer';
                el.innerHTML = `<i class="fas ${f.icon} text-xl"></i><div><div class="text-sm font-semibold text-gray-800">${f.name}</div><div class="text-xs text-gray-500">${f.time}</div></div>`;
                rec.appendChild(el);
            });
        }

        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                menu.style.display = 'none';
            } else {
                menu.style.display = 'flex';
                setTimeout(() => menu.classList.add('active'), 10);
            }
        }

        function systemAction(act) {
            document.body.innerHTML = `<div class="w-full h-screen bg-black flex items-center justify-center text-white flex-col"><div class="loader"></div><div class="mt-4">מתנתק...</div></div>`;
            setTimeout(() => location.reload(), 2000);
        }

        // --- Window Manager (Advanced) ---
        function openWindow(appId, fileContent = null, fileName = null) {
            const app = apps.find(a => a.id === appId);
            if (!app) return;
            
            // If dragging window logic requires pointer events on container
            document.getElementById('windows-container').style.pointerEvents = 'auto';

            const id = appId + '_' + Date.now();
            zIndex++;

            const win = document.createElement('div');
            win.className = 'window glass';
            win.id = id;
            win.style.width = app.w + 'px';
            win.style.height = app.h + 'px';
            win.style.zIndex = zIndex;
            win.style.top = (50 + Math.random() * 50) + 'px';
            win.style.left = (50 + Math.random() * 50) + 'px'; // LTR pos for logic, visual RTL handled by CSS

            // Header Construction
            const header = document.createElement('div');
            header.className = 'window-header';
            header.innerHTML = `
                <div class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                    <i class="fas ${app.icon} ${app.color}"></i>
                    <span>${fileName ? fileName + ' - ' : ''}${app.name}</span>
                </div>
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-green-500 cursor-pointer hover:bg-green-600" title="Maximize"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400 cursor-pointer hover:bg-yellow-500" title="Minimize" onclick="minimizeWindow('${id}')"></div>
                    <div class="w-3 h-3 rounded-full bg-red-500 cursor-pointer hover:bg-red-600" title="Close" onclick="closeWindow('${id}')"></div>
                </div>
            `;
            
            // Header Drag Logic
            header.onmousedown = (e) => {
                if(e.target.closest('.rounded-full')) return; // Don't drag on buttons
                zIndex++; win.style.zIndex = zIndex; // Bring to front
                let shiftX = e.clientX - win.getBoundingClientRect().left;
                let shiftY = e.clientY - win.getBoundingClientRect().top;
                function moveAt(pageX, pageY) {
                    win.style.left = pageX - shiftX + 'px';
                    win.style.top = pageY - shiftY + 'px';
                }
                function onMouseMove(event) { moveAt(event.pageX, event.pageY); }
                document.addEventListener('mousemove', onMouseMove);
                header.onmouseup = () => { document.removeEventListener('mousemove', onMouseMove); header.onmouseup = null; };
            };

            const content = document.createElement('div');
            content.className = 'window-content';
            
            // Build Structure
            win.appendChild(header);
            win.appendChild(content);
            document.getElementById('windows-container').appendChild(win);
            
            // Update Taskbar
            document.getElementById(`task-${app.id}`).classList.add('active');
            activeWindows[id] = { el: win, app: app };

            // Initialize App Content
            if (app.content) {
                content.innerHTML = app.content;
            } else if (app.init) {
                app.init(content, id, fileContent, fileName);
            }
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            if(win) {
                win.style.transform = "scale(0.9) opacity(0)";
                setTimeout(() => {
                    win.remove();
                    delete activeWindows[id];
                    // Check if other windows of same app exist to keep taskbar dot
                    const appId = id.split('_')[0];
                    const stillOpen = Object.keys(activeWindows).some(k => k.startsWith(appId));
                    if(!stillOpen) document.getElementById(`task-${appId}`).classList.remove('active');
                    
                    if (Object.keys(activeWindows).length === 0) {
                         document.getElementById('windows-container').style.pointerEvents = 'none';
                    }
                }, 200);
            }
        }

        function minimizeWindow(id) {
            const win = document.getElementById(id);
            win.style.transform = "translateY(100px) scale(0.8) opacity(0)";
            setTimeout(() => win.style.display = 'none', 300);
        }

        // --- APPS IMPLEMENTATION ---

        // 1. Settings App
        function initSettings(container) {
            container.innerHTML = `
                <div class="flex h-full bg-[#f3f4f6]">
                    <!-- Sidebar -->
                    <div class="w-64 bg-white/50 backdrop-blur border-l border-gray-200 p-4 flex flex-col gap-1">
                        <div class="flex items-center gap-3 p-2 mb-4">
                            <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center">A</div>
                            <div>
                                <div class="font-bold text-sm">Admin</div>
                                <div class="text-xs text-gray-500">Local Account</div>
                            </div>
                        </div>
                        <div class="p-2 bg-blue-100/50 text-blue-700 rounded-md font-medium text-sm cursor-pointer"><i class="fas fa-desktop w-6"></i> התאמה אישית</div>
                        <div class="p-2 hover:bg-gray-100 rounded-md text-gray-700 text-sm cursor-pointer"><i class="fas fa-wifi w-6"></i> רשת ואינטרנט</div>
                        <div class="p-2 hover:bg-gray-100 rounded-md text-gray-700 text-sm cursor-pointer"><i class="fas fa-th w-6"></i> אפליקציות</div>
                    </div>
                    <!-- Content -->
                    <div class="flex-grow p-8 overflow-auto">
                        <h2 class="text-2xl font-bold mb-6">התאמה אישית</h2>
                        <div class="mb-2 font-semibold text-gray-700">בחר רקע לשולחן העבודה</div>
                        <div class="grid grid-cols-3 gap-4">
                            ${wallpapers.map(url => `
                                <div class="aspect-video rounded-lg overflow-hidden cursor-pointer border-2 border-transparent hover:border-blue-500 transition shadow-sm bg-gray-200" onclick="setWallpaper('${url}')">
                                    <img src="${url}" class="w-full h-full object-cover">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        window.setWallpaper = (url) => {
            document.getElementById('wallpaper').style.backgroundImage = `url('${url}')`;
        };

        // 2. File Explorer (Advanced)
        function initExplorer(container, winId) {
            let currentViewPath = [...vfs.currentPath]; // Local copy for this window

            container.innerHTML = `
                <div class="flex flex-col h-full bg-white text-sm select-none">
                    <!-- Toolbar -->
                    <div class="h-10 border-b flex items-center px-2 gap-2 bg-gray-50">
                        <button class="hover:bg-gray-200 p-1 rounded" onclick="expBack('${winId}')"><i class="fas fa-arrow-right"></i></button>
                        <button class="hover:bg-gray-200 p-1 rounded"><i class="fas fa-arrow-up"></i></button>
                        <div class="flex-grow border rounded px-2 py-1 bg-white text-gray-600 ml-2" id="exp-path-${winId}">PC > Documents</div>
                        <div class="w-48 border rounded px-2 py-1 bg-white text-gray-400">Search</div>
                    </div>
                    <!-- Body -->
                    <div class="flex flex-grow overflow-hidden">
                        <!-- Tree -->
                        <div class="w-48 border-l bg-gray-50/50 p-2 flex flex-col gap-1 overflow-auto">
                            <div class="tree-node active"><i class="fas fa-star text-yellow-400"></i> גישה מהירה</div>
                            <div class="tree-node"><i class="fas fa-desktop text-blue-400"></i> Desktop</div>
                            <div class="tree-node" onclick="expNav('${winId}', ['Users','Admin','Documents'])"><i class="fas fa-file-alt text-yellow-500"></i> Documents</div>
                            <div class="tree-node"><i class="fas fa-download text-blue-500"></i> Downloads</div>
                            <div class="tree-node"><i class="fas fa-image text-purple-500"></i> Pictures</div>
                        </div>
                        <!-- Content Grid -->
                        <div class="flex-grow bg-white p-4 overflow-auto">
                            <div class="grid grid-cols-6 gap-2" id="exp-grid-${winId}">
                                <!-- Files go here -->
                            </div>
                        </div>
                    </div>
                    <!-- Status -->
                    <div class="h-6 border-t bg-gray-50 flex items-center px-2 text-xs text-gray-500 gap-4">
                        <span id="exp-count-${winId}">0 פריטים</span>
                    </div>
                </div>
            `;
            // Attach state to DOM element for simple retrieval
            container.dataset.path = JSON.stringify(currentViewPath);
            renderExplorerContent(winId);
        }

        window.expNav = (winId, newPath) => {
            const container = document.getElementById(winId).querySelector('.window-content');
            container.dataset.path = JSON.stringify(newPath);
            renderExplorerContent(winId);
        };

        function renderExplorerContent(winId) {
            const container = document.getElementById(winId).querySelector('.window-content');
            const grid = document.getElementById(`exp-grid-${winId}`);
            const pathDisp = document.getElementById(`exp-path-${winId}`);
            const countDisp = document.getElementById(`exp-count-${winId}`);
            
            const currentPath = JSON.parse(container.dataset.path);
            const folder = vfs.resolvePath(currentPath);
            
            pathDisp.innerText = currentPath.join(' > ');
            grid.innerHTML = '';
            
            if (folder && folder.children) {
                const items = Object.entries(folder.children);
                countDisp.innerText = `${items.length} פריטים`;
                
                items.forEach(([name, data]) => {
                    const el = document.createElement('div');
                    el.className = 'file-grid-item';
                    let icon = 'fa-file';
                    let color = 'text-gray-400';
                    
                    if (data.type === 'folder') { icon = 'fa-folder'; color = 'text-yellow-400'; }
                    else if (name.endsWith('.docx')) { icon = 'fa-file-word'; color = 'text-blue-600'; }
                    else if (name.endsWith('.xlsx')) { icon = 'fa-file-excel'; color = 'text-green-600'; }
                    
                    el.innerHTML = `<i class="fas ${icon} text-3xl ${color}"></i><span class="text-xs break-all leading-tight">${name}</span>`;
                    el.ondblclick = () => {
                        if (data.type === 'folder') {
                            const newPath = [...currentPath, name];
                            expNav(winId, newPath);
                        } else {
                            // Open file
                            if (data.app) openWindow(data.app, data.content, name);
                            else alert('אין אפליקציה משויכת לקובץ זה');
                        }
                    };
                    grid.appendChild(el);
                });
            }
        }

        // 3. Word App (With Save)
        function initWord(container, winId, content = '', fileName = null) {
            container.innerHTML = `
                <div class="flex flex-col h-full bg-gray-100">
                    <div class="bg-[#2b579a] text-white px-4 py-2 flex items-center justify-between text-sm">
                        <div class="flex gap-4">
                            <span class="hover:bg-white/20 px-2 rounded cursor-pointer" onclick="saveFile('${winId}', 'word')"><i class="fas fa-save"></i> שמור</span>
                            <span>קובץ</span> <span>בית</span> <span>הוספה</span>
                        </div>
                    </div>
                    <div class="bg-white border-b p-2 flex gap-2">
                        <select class="border text-xs p-1"><option>Arial</option></select>
                        <button class="w-6 border rounded hover:bg-gray-100 font-bold">B</button>
                        <button class="w-6 border rounded hover:bg-gray-100 italic">I</button>
                    </div>
                    <div class="flex-grow p-8 overflow-auto flex justify-center bg-gray-200">
                        <div id="word-doc-${winId}" class="bg-white w-[21cm] min-h-[29.7cm] shadow-lg p-[2.5cm] outline-none text-right" contenteditable="true">
                            ${content || '<h1 class="text-2xl font-bold mb-4">מסמך חדש</h1><p>התחל להקליד...</p>'}
                        </div>
                    </div>
                </div>
            `;
            container.dataset.filename = fileName || '';
        }

        // 4. Excel App
        function initExcel(container, winId, content = '', fileName = null) {
            container.innerHTML = `
                <div class="flex flex-col h-full bg-white">
                    <div class="bg-[#217346] text-white px-4 py-2 text-sm flex gap-4">
                        <span class="cursor-pointer hover:bg-white/20 px-2 rounded" onclick="saveFile('${winId}', 'excel')"><i class="fas fa-save"></i> שמור</span>
                        <span>בית</span> <span>הוספה</span>
                    </div>
                    <div class="flex-grow overflow-auto relative bg-white">
                        <div class="grid grid-cols-[40px_repeat(10,100px)]">
                             <div class="bg-gray-100 border-b border-r"></div>
                             ${Array.from({length:10}, (_,i)=>`<div class="bg-gray-100 border-b border-r text-center text-xs p-1 font-bold">${String.fromCharCode(65+i)}</div>`).join('')}
                             ${Array.from({length:20}, (_,r)=>
                                `<div class="bg-gray-100 border-b border-r text-center text-xs p-1">${r+1}</div>` +
                                Array.from({length:10}, ()=>`<input class="border-b border-r text-xs p-1 outline-none focus:border-green-500 focus:border-2">`).join('')
                             ).join('')}
                        </div>
                    </div>
                </div>
            `;
            container.dataset.filename = fileName || '';
            // Pre-fill content (very basic parsing)
             if(content) {
                 // Mock loading content logic would go here
             }
        }

        // 5. CMD
        function initCMD(container, winId) {
            let path = ['Users', 'Admin'];
            container.innerHTML = `
                <div class="bg-[#0c0c0c] text-gray-300 font-mono text-sm h-full p-2 overflow-auto" id="term-${winId}" onclick="document.getElementById('in-${winId}').focus()">
                    <div>Microsoft Windows [Version 12.0.22621.1]<br>(c) Microsoft Corporation. All rights reserved.</div><br>
                    <div id="hist-${winId}"></div>
                    <div class="flex">
                        <span class="mr-2 text-white">C:\\Users\\Admin></span>
                        <input id="in-${winId}" class="bg-transparent border-none outline-none text-gray-100 flex-grow" autocomplete="off">
                    </div>
                </div>
            `;
            const input = document.getElementById(`in-${winId}`);
            const hist = document.getElementById(`hist-${winId}`);
            
            input.onkeydown = (e) => {
                if(e.key === 'Enter') {
                    const cmdLine = input.value.trim();
                    const parts = cmdLine.split(' ');
                    const cmd = parts[0].toLowerCase();
                    
                    hist.innerHTML += `<div><span class="text-white">C:\\Users\\Admin></span> ${cmdLine}</div>`;
                    
                    // Basic Logic
                    if(cmd === 'dir') {
                        // List files from VFS (Mock path for demo)
                        const files = vfs.listFiles(['Users','Admin','Documents']);
                        Object.keys(files).forEach(f => {
                            hist.innerHTML += `<div>01/01/2025  12:00 PM    <DIR>          ${f}</div>`;
                        });
                    } else if (cmd === 'cls') {
                        hist.innerHTML = '';
                    } else if (cmd === 'echo') {
                        hist.innerHTML += `<div>${cmdLine.substring(5)}</div>`;
                    } else if (cmd === 'help') {
                         hist.innerHTML += `<div>Available commands: dir, cls, echo, help, exit</div>`;
                    } else if (cmd === 'exit') {
                        closeWindow(winId);
                    } else {
                        hist.innerHTML += `<div class="text-red-400">'${cmd}' is not recognized as an internal or external command.</div>`;
                    }
                    
                    input.value = '';
                    container.scrollTop = container.scrollHeight;
                }
            };
        }

        // 6. Notepad
        function initNotepad(container, winId, content = '', fileName = null) {
            container.innerHTML = `
                <div class="flex flex-col h-full bg-white">
                    <div class="flex gap-2 p-1 text-sm border-b">
                         <button onclick="saveFile('${winId}', 'txt')" class="hover:bg-gray-100 px-2 rounded">שמור</button>
                         <button class="hover:bg-gray-100 px-2 rounded">עריכה</button>
                    </div>
                    <textarea id="note-${winId}" class="flex-grow resize-none border-none outline-none p-2 font-mono text-sm">${content}</textarea>
                </div>
            `;
            container.dataset.filename = fileName || '';
        }

        // --- Shared "Save" Logic ---
        window.saveFile = (winId, type) => {
            const container = document.getElementById(winId).querySelector('.window-content');
            let content = '';
            let ext = '';
            
            if (type === 'word') {
                content = document.getElementById(`word-doc-${winId}`).innerHTML;
                ext = '.docx';
            } else if (type === 'txt') {
                content = document.getElementById(`note-${winId}`).value;
                ext = '.txt';
            } else if (type === 'excel') {
                content = 'Spreadsheet Data...';
                ext = '.xlsx';
            }

            let filename = container.dataset.filename;
            if (!filename) {
                filename = prompt('שמור קובץ בשם:', 'MyFile' + ext);
                if (!filename) return;
                if (!filename.endsWith(ext)) filename += ext;
            }

            // Save to VFS (Hardcoded path to Documents for demo simplicity)
            vfs.writeFile(['Users', 'Admin', 'Documents'], filename, content, apps.find(a => a.id === type)?.id);
            alert('הקובץ נשמר בהצלחה בתיקיית Documents!');
            
            // Refresh any open explorers
            Object.values(activeWindows).forEach(w => {
                if (w.app.id === 'explorer') {
                    // Check if looking at documents, then refresh
                    // For simplicity, just force refresh current view
                    const winId = w.el.id;
                    const path = JSON.parse(w.el.querySelector('.window-content').dataset.path);
                    expNav(winId, path);
                }
            });
        };

    </script>
</body>
</html>
